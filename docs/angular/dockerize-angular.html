<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TL;DR:</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/web-development-guidelines/assets/css/0.styles.55b66cfc.css" as="style"><link rel="preload" href="/web-development-guidelines/assets/js/app.619e207b.js" as="script"><link rel="preload" href="/web-development-guidelines/assets/js/11.d21adb37.js" as="script"><link rel="prefetch" href="/web-development-guidelines/assets/js/15.35f51890.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/2.cda51ec0.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/3.9f1531d6.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/4.87c874f8.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/5.dd094de2.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/6.e9c321fb.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/7.250c8d9d.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/8.348a10fe.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/9.6392689b.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/10.bd1c58ab.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/12.3cd62bb9.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/13.b26b65b0.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/14.8faec2af.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/16.94cda7f5.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/17.0c7f3574.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/18.b59d2269.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/19.ade22912.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/20.3662ab7a.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/21.d8d39710.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/22.97a30b23.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/23.4c4f544d.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/24.64505df8.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/25.0dd8fbbb.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/26.be3c1b35.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/27.4ecc62cd.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/28.be69aaab.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/29.b3a0daa6.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/30.3e451a60.js"><link rel="prefetch" href="/web-development-guidelines/assets/js/31.f23344bd.js">
    <link rel="stylesheet" href="/web-development-guidelines/assets/css/0.styles.55b66cfc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/web-development-guidelines/" class="home-link router-link-active"></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <!----> </div> <div class="page"> <div class="content"><p>Here's how to deploy an <a href="https://angular.io/" target="_blank" rel="noopener noreferrer">Angular<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> app with <a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">Docker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, building it with <a href="https://nodejs.org" target="_blank" rel="noopener noreferrer">Node.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as you would do locally, but end up with a thin and efficient <a href="https://nginx.org/" target="_blank" rel="noopener noreferrer">Nginx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> image, with just the compiled code. Ready for production.</p> <p>To achieve that, you can use <a href="https://docs.docker.com/engine/userguide/eng-image/multistage-build/" target="_blank" rel="noopener noreferrer">Docker &quot;multi-stage builds&quot;<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. That will allow you to first build your Angular app inside a (possibly huge) Node JS Docker container that is later discarded in favor of a thin Nginx image with just your compiled app. And your final image will be as thin as the latest layer (Nginx).</p> <p>Here you will also see how to use that technique but still support <a href="https://github.com/angular/angular-cli" target="_blank" rel="noopener noreferrer">Angular CLI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://github.com/angular/angular-cli/wiki/stories-application-environments" target="_blank" rel="noopener noreferrer">environments / configurations<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>All this removes the need for complex building scripts or the need to add your built app to git (your <code>dist</code> directory).</p> <p>Also, optionally, you can run your Karma tests in Chrome Headless inside the Docker container. All the information is in the last section.</p> <p>This could also be adapted to any compiled frontend framework like <a href="https://reactjs.org/" target="_blank" rel="noopener noreferrer">React<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. But the main tricks you need are all below.</p> <h2 id="tl-dr"><a href="#tl-dr" aria-hidden="true" class="header-anchor">#</a> TL;DR:</h2> <ul><li>Create a new Angular project, e.g. &quot;my-angular-project&quot;:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>ng new my-angular-project
</code></pre></div><ul><li>Enter into your project directory:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cd</span> my-angular-project
</code></pre></div><ul><li>While developing, use <code>ng serve</code> as you normally would, to be able to use live-reload and other features. But for production deployment with Docker, and to test the &quot;production deployment&quot; locally, do the following.</li> <li>Add a <code>.dockerignore</code> for <code>node_modules</code> with:</li></ul> <div class="language- extra-class"><pre class="language-text"><code>node_modules
</code></pre></div><ul><li>Add a <code>Dockerfile</code> to your directory with:</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code># Stage 0, &quot;build-stage&quot;, based on Node.js, to build and compile the frontend
FROM tiangolo/node-frontend:10 as build-stage

WORKDIR /app

COPY package*.json /app/

RUN npm install

COPY ./ /app/

ARG configuration=production

RUN npm run build -- --output-path=./dist/out --configuration $configuration


# Stage 1, based on Nginx, to have only the compiled app, ready for production with Nginx
FROM nginx:1.15

COPY --from=build-stage /app/dist/out/ /usr/share/nginx/html

# Copy the default nginx.conf provided by tiangolo/node-frontend
COPY --from=build-stage /nginx.conf /etc/nginx/conf.d/default.conf
</code></pre></div><ul><li>Build your image using the production configuration (the default), e.g.:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t my-angular-project:prod <span class="token keyword">.</span>
</code></pre></div><ul><li>Build your image using the development environment (no configuration), e.g.:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t my-angular-project:dev --build-arg configuration<span class="token operator">=</span><span class="token string">&quot;&quot;</span> <span class="token keyword">.</span>
</code></pre></div><ul><li>Test your image for the production environment (production configuration) with:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -p 80:80 my-angular-project:prod
</code></pre></div><ul><li>Open your browser in <a href="http://localhost" target="_blank" rel="noopener noreferrer">http://localhost<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li> <li>Test your image for the development environment (no configuration) with:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -p 80:80 my-angular-project:dev
</code></pre></div><ul><li>Open your browser in <a href="http://localhost" target="_blank" rel="noopener noreferrer">http://localhost<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li> <li>If you are using testing and want to integrate it, read the last section.</li></ul> <p><em>Everything above shows the actual code you need. If you're in a hurry, you could probably just copy all that. If you want to know all the details, continue reading...</em></p> <hr> <h2 id="docker-image-in-detail"><a href="#docker-image-in-detail" aria-hidden="true" class="header-anchor">#</a> Docker Image in detail</h2> <p>When you build an Angular front-end app, you most commonly write it in <a href="http://www.typescriptlang.org/" target="_blank" rel="noopener noreferrer">TypeScript<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and then compile it to JavaScript. But you need to have Node.js and several packages to do that.</p> <p>After you compile your app, you end up with a set of files, normally in a directory with the name of your app inside a  <code>./dist</code> directory. Those are the compiled files that you actually use to serve your app. And those files have all the optimizations that you use, for example, AOT (Ahead Of Time compilation).</p> <p>And those files are the final product that you serve to your users. Your users don't need your source TypeScript files nor any of the packages you use during development, just the compiled files.</p> <p>So, you need to &quot;deploy to production&quot; only those files.</p> <p>These are the options we have, take them as the &quot;motivation&quot; for what we will do next:</p> <h4 id="option-1"><a href="#option-1" aria-hidden="true" class="header-anchor">#</a> Option 1:</h4> <p>One way to do it is to compile the app locally and add the compiled files to your Git repository. And then, when you are deploying, you just clone your repository and use those compiled files. As we are talking about Docker, you would create an image that copies and uses those compiled files. You would probably use an <a href="https://hub.docker.com/_/nginx/" target="_blank" rel="noopener noreferrer">Nginx base image<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for that.</p> <p>But you never edit those compiled files directly, they are generated from your source files. They are constantly changing, so your Git repository will grow large just because you are adding compiled code. And if someone in your team works on a feature branch and has one version of those files and he wants to merge the feature to your main branch (probably <code>master</code>), you might have lots conflicts in those files, even when the source code doesn't have conflicts. So you would have to be fixing &quot;virtual&quot; conflicts. There are probably other disadvantages too. So, the compiled files don't really belong in your Git repository.</p> <p>Also, if you forget to compile and commit everything right before deploying, you'll get an old version of the deployed app.</p> <h4 id="option-2"><a href="#option-2" aria-hidden="true" class="header-anchor">#</a> Option 2:</h4> <p>Another way to do it would be to do not add your compiled code to your Git repository and build your app every time you are going to deploy.</p> <p>But this would require all your deployment servers or wherever it is that you build your Docker image to have all the tooling to deploy your app. Node.js, TypeScript, all the Angular packages, all the dependencies, etc.</p> <p>And again, if you forget to compile everything right before deploying, you'll get an old version of the app deployed.</p> <p>But all the problems that you would have with dependencies by needing to have all the tooling in a server is what Docker is supposed to solve, right?</p> <h4 id="option-3"><a href="#option-3" aria-hidden="true" class="header-anchor">#</a> Option 3:</h4> <p>You could build the whole app inside your Docker image, and then serve it from the same image.</p> <p>That would imply that you would start from an <a href="https://hub.docker.com/_/node/" target="_blank" rel="noopener noreferrer">official Node.js base image<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to compile everything and then you would have to setup a server with Node.js or install Nginx manually on top of Node.js (or something similar).</p> <p>If you install Nginx by hand you lose the option to use the <a href="https://hub.docker.com/_/nginx/" target="_blank" rel="noopener noreferrer">official Nginx base image<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that is already fine tuned.</p> <p>Also, you would end up with huge images that all your deployment servers have to download (if you are concerned about size) and a complex environment, with all the Node.js / Angular packages and dependencies.</p> <h4 id="option-4"><a href="#option-4" aria-hidden="true" class="header-anchor">#</a> Option 4:</h4> <p>You could write a complex script that builds your app in one Docker image using Node.js, then extract the compiled files, and then build a second image based on Nginx with just your compiled files.</p> <p>We are getting close, but you would have another complex script to debug. Copying files from a Docker container and to another Docker image, etc. Not that promising...</p> <h4 id="option-5"><a href="#option-5" aria-hidden="true" class="header-anchor">#</a> Option 5:</h4> <p>Use <a href="https://docs.docker.com/engine/userguide/eng-image/multistage-build/" target="_blank" rel="noopener noreferrer">Docker multi-stage builds<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. With that, you can have a Node.js base image that installs, builds and compiles everything, and then, &quot;discard&quot; all those Node.js specific Docker image layers, and end up with a Nginx image with just your compiled code.</p> <p>You would have an efficient Nginx server with great performance for your static final (compiled) files. You wouldn't have to add your compiled code to Git, you always get the latest compiled version of your code, you don't have to deal with dependencies outside Docker, etc.</p> <p>That's great! Docker multi-stage builds solve several problems in one shot. And this option is what is <a href="https://medium.com/@avatsaev/create-efficient-angular-docker-images-with-multi-stage-builds-907e2be3008d" target="_blank" rel="noopener noreferrer">described in this article: &quot;Create efficient Angular Docker images with Multi Stage Builds&quot;<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. But...</p> <p>When building your Angular code with <a href="https://github.com/angular/angular-cli" target="_blank" rel="noopener noreferrer">Angular CLI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> you have the option to use <a href="https://github.com/angular/angular-cli/wiki/stories-application-environments" target="_blank" rel="noopener noreferrer">&quot;configurations&quot; to set the <code>environment</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> while building the Angular app. That alows you to, for example, use a production back end API while using the &quot;<code>production</code>&quot; environment / configuration and use a testing back end API while using the unmodified configuration (development environment).</p> <p>But with just the method described above we would have no way to use that feature.</p> <hr> <p>So, let's create an <strong>Option 6</strong> that combines all of the above and lets us use Angular CLI configurations / environments.</p> <h3 id="requirements"><a href="#requirements" aria-hidden="true" class="header-anchor">#</a> Requirements</h3> <ul><li><a href="https://github.com/angular/angular-cli" target="_blank" rel="noopener noreferrer">Angular CLI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (you need to have <a href="https://nodejs.org" target="_blank" rel="noopener noreferrer">Node.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> first)</li> <li><a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">Docker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="angular"><a href="#angular" aria-hidden="true" class="header-anchor">#</a> Angular</h3> <p>If you don't know Angular (Angular 2+) yet, go and do <a href="https://angular.io/docs" target="_blank" rel="noopener noreferrer">their tutorials<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> first.</p> <p>If you are building an Angular front-end web app, you probably should create your code with <a href="https://github.com/angular/angular-cli" target="_blank" rel="noopener noreferrer">Angular CLI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>That will help you setting everything up, compiling the app with AOT (Ahead Of Time compilation), serving the app during development with automatic live-reload, etc.</p> <ul><li>So, go ahead and install <a href="https://github.com/angular/angular-cli" target="_blank" rel="noopener noreferrer">Angular CLI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li> <li>To create a new Angular project, e.g. &quot;my-angular-project&quot;, run:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>ng new my-angular-project
</code></pre></div><ul><li>Enter into your project directory:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cd</span> my-angular-project
</code></pre></div><ul><li>To be able to see the differences between the Angular CLI environments in the final app, edit your component code in <code>src/app/app.component.ts</code>, import the <code>environment</code>:</li></ul> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> environment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../environments/environment'</span><span class="token punctuation">;</span>

<span class="token operator">...</span>
</code></pre></div><ul><li>Then, add that environment's <code>production</code> property as a component property, so that you can use it in your template:</li></ul> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code><span class="token operator">...</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>

<span class="token operator">...</span>

  production <span class="token operator">=</span> environment<span class="token punctuation">.</span>production<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Your final code might look like:</li></ul> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> environment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../environments/environment'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
  templateUrl<span class="token punctuation">:</span> <span class="token string">'./app.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./app.component.css'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  title <span class="token operator">=</span> <span class="token string">'app'</span><span class="token punctuation">;</span>

  production <span class="token operator">=</span> environment<span class="token punctuation">.</span>production<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Then, edit your template to show your <code>production</code> value, for example, add the following:</li></ul> <div class="language-html extra-class"><pre class="language-html"><code>...

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>production<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>We are running in production!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>!production<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>We are running in development...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>

...
</code></pre></div><ul><li>Your final template might look like:</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">text-align</span><span class="token punctuation">:</span>center</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>
Welcome to {{title}}!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>production<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>We are running in production!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>!production<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>We are running in development...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>Note</strong>: I'm omitting some of the default Angular CLI code for brevity.</p> <ul><li>Now, if you run your code locally with the defaults, e.g.:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>ng serve
</code></pre></div><ul><li>And open your browser in <a href="http://localhost:4200" target="_blank" rel="noopener noreferrer">http://localhost:4200<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>...you will see your code using the default development environment (no configuration). So you might probably see something like:</p> <img src="https://github.com/tiangolo/medium-posts/raw/master/angular-in-docker/readme-assets/01.png"> <ul><li>But if you run it passing the <code>--prod</code> flag (or the more specific <code>--configuration=production</code>), e.g.:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>ng serve --prod
</code></pre></div><ul><li>And open your browser in <a href="http://localhost:4200" target="_blank" rel="noopener noreferrer">http://localhost:4200<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>...you will probably see something like:</p> <img src="https://github.com/tiangolo/medium-posts/raw/master/angular-in-docker/readme-assets/02.png"> <p><em>notice the &quot;<code>running in production!</code>&quot;</em>.</p> <ul><li>To learn more about Angular CLI environments and configurations, check <a href="https://github.com/angular/angular-cli/wiki/stories-application-environments" target="_blank" rel="noopener noreferrer">the official Angular CLI documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li></ul> <p>This is a bare-bones Angular project. Just the basic parts to show the point. There are many ways to improve Angular using modules, etc. But we'll just stick to the basics for now.</p> <h3 id="nginx"><a href="#nginx" aria-hidden="true" class="header-anchor">#</a> Nginx</h3> <p>Nowadays, Nginx is more or less the &quot;de facto standard&quot; for static content serving. You can search about it and read about its performance. The web is full of articles about it.</p> <p>So, for our final Docker image, we will need to have a Nginx configuration. You don't really need to know much more about it for now. As the official Docker image will do all the heavy lifting for you.</p> <h4 id="update"><a href="#update" aria-hidden="true" class="header-anchor">#</a> Update:</h4> <p>This article is now based on the image <code>tiangolo/node-frontend</code> and it already provides a default Nginx configuration, you just have to copy it in the last stage (don't worry, I'll cover it below). That configuration file makes sure that all the routes go to <code>index.html</code>, so that you can use your frontend router and it will work even if your users type the URL directly in the browser. If you don't want to use that image but build it form scratch based on <code>node</code>, do the following steps.</p> <hr> <p><strong>Optional read</strong></p> <p>If you want to build your image based on Node.js directly, you need to create an Nginx config file.</p> <ul><li>Add a Nginx configuration inside your project directory, named <code>nginx-custom.conf</code>, with:</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>
    <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
    <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span><span class="token operator">/</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>The most important part is the:</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span><span class="token operator">/</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">;</span>
</code></pre></div><p>...that tells Nginx to try to match the files it is requested in the URL (URI) with files it has available. That will make it, for example, match the <code>/main.bundle.js</code> and return the JavaScript file. But when there's no match, it will default to <code>index.html</code>.</p> <p>That will make it return the <code>index.html</code> for any other URL it receives, so, all the Angular router URLs will work, even when going to the URL directly in the browser (not being redirected from an internal section of the app).</p> <p>Without that, if you had a route like <code>/app/dashbaord/main</code>, when you tried to open that URL, Nginx wouldn't find the file <code>app/dashboard/main</code> and would return a <code>404 Not found</code>, instead of returning the <code>index.html</code> and letting the Angular router handle it.</p> <p>The last part, <code>=404</code> tells Nginx to return a <code>404</code> if it doesn't even find an <code>index.html</code> file. That's the default case. But you will normally always have an <code>index.html</code> file.</p> <p>Save that file, we will use it soon.</p> <p>This is the minimum Nginx configuration. You could finetune it more, depending on your case. If you want to explore more, read the <a href="http://nginx.org/en/docs/beginners_guide.html#conf_structure" target="_blank" rel="noopener noreferrer">Nginx Beginner's Guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p><strong>End optional read</strong></p> <hr> <h3 id="docker"><a href="#docker" aria-hidden="true" class="header-anchor">#</a> Docker</h3> <p>If you don't know Docker yet, and you do at least some back-end stuff (deploying a front-end app counts), it might change your developer life. So, go ahead, <a href="https://docs.docker.com/engine/installation/" target="_blank" rel="noopener noreferrer">install Docker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and follow the <a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener noreferrer">Get Started guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Now, let's assume you already know enough Docker to use it. Let's go to our details.</p> <p>Here, we'll see how we can use Docker multi-stage builds <a href="https://docs.docker.com/engine/reference/builder/#arg" target="_blank" rel="noopener noreferrer">Docker build-time <code>ARG</code>s<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. That will allow us to pass build-time variables during image creation. And with that, we'll be able to build different images for the different Angular CLI environments, by just passing an argument to <code>docker</code>. But we need to do a couple things first.</p> <p>When you build your image, Docker normally &quot;sends&quot; all the files in the directory to the component of Docker that builds the image. If you have a <code>node_modules</code> directory, it will take some time sending that as <code>node_modules</code> directories tend to be huge and with lots of files. But you don't need <code>node_modules</code> to be copied to your Docker image, you will install everything inside and create a <code>node_modules</code> inside your container, so, sending all your <code>node_modules</code> is a waste of time.</p> <p>The same way that you would add <code>node_modules</code> to your <code>.gitignore</code> file, you can use a <code>.dockerignore</code> file to tell Docker that it shouldn't &quot;send&quot; that directory.</p> <ul><li>Add a <code>.dockerignore</code> for <code>node_modules</code> with:</li></ul> <div class="language- extra-class"><pre class="language-text"><code>node_modules
</code></pre></div><p>Now, let's build our Docker image.</p> <ul><li>Add a file specifically named <code>Dockerfile</code> in your directory, with:</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code># Stage 0, &quot;build-stage&quot;, based on Node.js, to build and compile Angular
FROM tiangolo/node-frontend:10 as build-stage

WORKDIR /app

COPY package*.json /app/

RUN npm install

COPY ./ /app/

ARG configuration=production

RUN npm run build -- --output-path=./dist/out --configuration $configuration


# Stage 1, based on Nginx, to have only the compiled app, ready for production with Nginx
FROM nginx:1.15

COPY --from=build-stage /app/dist/out/ /usr/share/nginx/html

COPY --from=build-stage /nginx.conf /etc/nginx/conf.d/default.conf
</code></pre></div><p>...now, let's check what all that is doing.</p> <ul><li>This will tell Docker that we will start with a base image <a href="https://hub.docker.com/r/tiangolo/node-frontend/" target="_blank" rel="noopener noreferrer">tiangolo/node-frontend<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> which in turn is based on the <a href="https://hub.docker.com/_/node/" target="_blank" rel="noopener noreferrer">Node.js official image<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, notice that you won't have to install and configure Node.js inside the Linux container or anything, Docker does that for you:</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>FROM tiangolo/node-frontend:10 as build-stage
</code></pre></div><p>...we also &quot;named&quot; this stage <code>build-stage</code>, with the <code>as build-stage</code>. We will use this name later.</p> <ul><li>Our working directory will be <code>/app</code>. This Docker &quot;instruction&quot; will create that directory and go inside of it, all the next steps will &quot;be&quot; in that directory:</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>WORKDIR /app
</code></pre></div><ul><li>Now, this instruction copies all the files that start with <code>package</code> and end with <code>.json</code> from your source to inside the container. With the <code>package*.json</code> it will include the <code>package.json</code> file and also the <code>package-lock.json</code> if you have one, but it won't fail if you don't have it. Just that file (or those 2 files), before the rest of the source code, because we want to install everything the first time, but not every time we change our source code. The next time we change our code and build the image, Docker will use the cached &quot;layers&quot; with everything installed (because the <code>package.json</code> hasn't changed) and will only compile our source code:</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>COPY package*.json /app/
</code></pre></div><ul><li>Install all the dependencies, this will be cached until we change the <code>package.json</code> file (changing our dependencies). So it won't take very long installing everything every time we iterate in our source code and try to test (or deploy) the production Docker image, just the first time and when we update the dependencies (installed packages):</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>RUN npm install
</code></pre></div><ul><li>Now, after installing all the dependencies, we can copy our source code. This section will not be cached that much, because we'll be changing our source code constantly, but we already took advantage of Docker caching for all the package install steps in the commands above. So, let's copy our source code:</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>COPY ./ /app/
</code></pre></div><ul><li>And here's the trick that will allow us to use Angular CLI &quot;configurations&quot; and enable different environments. We create an <code>ARG</code> that we will pass at <strong>build</strong> time with a default value of <code>production</code> (the default value for Angular CLI). This will be done at &quot;build time&quot;, while building the image, in contrast to at &quot;run time&quot;, which is while &quot;running&quot; or starting the image.</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>ARG configuration=production
</code></pre></div><ul><li>Inside our container we don't have a global Angular CLI installation, so we cannot just use <code>ng build</code>, because it won't find <code>ng</code>. But as Angular CLI creates an NPM script that builds everything, we can just use it, with <code>npm run build</code>. But we need to pass parameters to <code>ng</code> and we cannot pass them directly because <code>npm</code> would try to interpret them. So first we add <code>--</code> to let <code>npm</code> know that the next parameters are not for him, but for <code>ng</code>. Then, we pass the <code>--prod</code> parameter, the equivalent of <code>--configuration=production</code>, that <a href="https://github.com/angular/angular-cli/wiki/stories-application-environments" target="_blank" rel="noopener noreferrer">sets several things at once<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. That will take care of optimizing everything for production. And lastly, we pass the <code>--configuration $configuration</code> parameter. See that we are using the &quot;configuration variable&quot; <code>$configuration</code> that we created right above. This environment variable won't persist after building (as an environment variable), but we can use it to pass parameters to Docker at &quot;build time&quot;.</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>RUN npm run build -- --output-path=./dist/out --configuration $configuration
</code></pre></div><p>...that will build our app, to the directory <code>./dist/out</code>. Inside the container will be in <code>/app/dist/out</code>. We are specifying the specific <code>--output-path=./dist/out</code> because otherwise by default Angular CLI would use the name of the project, for example <code>./dist/my-angular-project</code>. But we need to have a specific path to use it later. So, by fixing it to <code>./dist/out</code> you can copy-paste it directly to your project without worrying about modifying paths in several places.</p> <ul><li>In the same <code>Dockerfile</code> file, we start another section (another &quot;stage&quot;), like if 2 <code>Dockerfile</code>s were concatenated. That's Docker multi-stage building. It almost just looks like concatenating <code>Dockerfile</code>s. So, let's start with an <a href="https://hub.docker.com/_/nginx/" target="_blank" rel="noopener noreferrer">official Nginx base image<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for this &quot;stage&quot;:</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>FROM nginx:1.15
</code></pre></div><p>...if you were very concerned about disk space (and you didn't have any other image that probably shares the same base layers), or if, for some reason, you are a fan of Alpine Linux, you could change that line and use an <a href="https://hub.docker.com/_/nginx/" target="_blank" rel="noopener noreferrer">Alpine version<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <ul><li>Here's the Docker multi-stage trick. This is a normal <code>COPY</code>, but it has a <code>--from=build-stage</code>. That <code>build-stage</code> refers to the name we specified above in the <code>as build-stage</code>. Here, although we are in a Nginx image, starting from scratch, we can copy files from a previous stage. So, we can copy the compiled fresh version of our app. That compiled version is based on the latest source code, and that latest compiled version only lives in the previous Docker &quot;stage&quot;, for now. But we'll copy it to the Nginx directory, just as static files:</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>COPY --from=build-stage /app/dist/out/ /usr/share/nginx/html
</code></pre></div><ul><li>Now, we'll override the <code>default.conf</code> file in Nginx with the custom <code>nginx.conf</code> provided in the image <code>tiangolo/node-frontend</code>. This configuration file directs everything to <code>index.html</code>, so that the Angular router can take care of it's routes:</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>COPY --from=build-stage /nginx.conf /etc/nginx/conf.d/default.conf
</code></pre></div><p>...that's it for the <code>Dockerfile</code>! Doing that with scripts or any other method would be a lot more cumbersome.</p> <hr> <p><strong>Optional read</strong></p> <p>If you don't want to use the image <code>tiangolo/node-frontend</code> but build yours from scratch based on <code>node</code> you can do it, you just have to create the Nignx config file descriibed in the Nginx section above and modify the line:</p> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>COPY --from=build-stage /nginx.conf /etc/nginx/conf.d/default.conf
</code></pre></div><p>to:</p> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>COPY ./nginx-custom.conf /etc/nginx/conf.d/default.conf
</code></pre></div><p>...have in mind that if you don't use <code>tiangolo/node-frontend</code> you will also have to install Puppeteer and all its dependencies by hand too.</p> <p><strong>End optional read</strong></p> <hr> <h3 id="build-it"><a href="#build-it" aria-hidden="true" class="header-anchor">#</a> Build it</h3> <p>Now we can build our image, doing it will compile everything and create a Nginx image ready for serving our app.</p> <p>If we just build it normally, it will use the production configuration (<code>production</code>) and environment.</p> <ul><li>Build your image using the production configuration / environment (the default), e.g.:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t my-angular-project:prod <span class="token keyword">.</span>
</code></pre></div><p>But we can build an image for each environment we have, by just passing the configuration name as an argument to the build process. The same as we would pass it to <code>ng build --configuration</code>. We just have to use Docker's <code>--build-arg</code> parameter.</p> <ul><li>Build your image passing an empty string as the <code>configuration</code> build arg, so that Angular CLI doesn't use a configuration and runs with the development environment, e.g.:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t my-angular-project:dev --build-arg configuration<span class="token operator">=</span><span class="token string">&quot;&quot;</span> <span class="token keyword">.</span>
</code></pre></div><ul><li>If you had a <code>staging</code> configuration and environment, you could build an image for that environment with:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t my-angular-project:dev --build-arg configuration<span class="token operator">=</span><span class="token string">&quot;staging&quot;</span> <span class="token keyword">.</span>
</code></pre></div><ul><li>All these additional builds, and all the next builds (including the <code>prod</code> one) will be very fast, as all the NPM packages will already be installed and Docker will re-use the cached layers. It will know it just has to copy your source code and compile it, etc. It won't install everything every time. And when you add a new dependency, your <code>package.json</code> will be modified, Docker will notice it and re-install the dependencies.</li></ul> <h3 id="test-it"><a href="#test-it" aria-hidden="true" class="header-anchor">#</a> Test it</h3> <p>To check that your new Docker images are working, you can start a container based on them and see the results.</p> <ul><li>Test your image for the production environment with:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -p 80:80 my-angular-project:prod
</code></pre></div><p>...you won't see any logs, just your terminal hanging there.</p> <ul><li>Open your browser in <a href="http://localhost" target="_blank" rel="noopener noreferrer">http://localhost<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li></ul> <p>You should see something very similar to:</p> <img src="https://github.com/tiangolo/medium-posts/raw/master/angular-in-docker/readme-assets/04.png"> <p>...notice that it is served by Docker and not by Angular CLI (not in port <code>4200</code>). And notice that it says that you are running the &quot;production&quot; version of your frontend App.</p> <ul><li>Test your image for the development environment with:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -p 80:80 my-angular-project:dev
</code></pre></div><ul><li>Open your browser in <a href="http://localhost" target="_blank" rel="noopener noreferrer">http://localhost<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li></ul> <p>You should see something very similar to:</p> <img src="https://github.com/tiangolo/medium-posts/raw/master/angular-in-docker/readme-assets/03.png"> <p>...again, served by Docker and not by Angular CLI (not in port <code>4200</code>). And now you are using your &quot;development&quot; environment version.</p> <h2 id="add-testing"><a href="#add-testing" aria-hidden="true" class="header-anchor">#</a> Add testing</h2> <p>If you are using testing with <a href="https://jasmine.github.io/" target="_blank" rel="noopener noreferrer">Jasmine<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://karma-runner.github.io/" target="_blank" rel="noopener noreferrer">Karma<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, you can run your tests using Chrome headless and integrate that in your <code>Dockerfile</code>.</p> <p>That will allow it to run in a Docker container, and you will be able to test your application before building it and integrate it with CI systems (e.g. GitLab CI).</p> <p>First, you need to add <a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener noreferrer">Puppeteer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as a dependency following <a href="https://github.com/karma-runner/karma-chrome-launcher#headless-chromium-with-puppeteer" target="_blank" rel="noopener noreferrer">Karma’s official documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <ul><li>Go to your application directory and install Puppeteer:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> puppeteer --save-dev
</code></pre></div><ul><li>Then install <code>karma-chrome-launcher</code>:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> karma-chrome-launcher --save-dev
</code></pre></div><ul><li>Modify your <code>src/karma.conf.js</code> file, add this on the top:</li></ul> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CHROME_BIN</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executablePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>Modify your <code>src/karma.conf.js</code> file, there's a line with:</li></ul> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>    browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Chrome'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>replace that line with:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>    browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Chrome'</span><span class="token punctuation">,</span> <span class="token string">'ChromeHeadlessNoSandbox'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    captureTimeout<span class="token punctuation">:</span> <span class="token number">210000</span><span class="token punctuation">,</span>
    browserDisconnectTolerance<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    browserDisconnectTimeout<span class="token punctuation">:</span> <span class="token number">210000</span><span class="token punctuation">,</span>
    browserNoActivityTimeout<span class="token punctuation">:</span> <span class="token number">210000</span><span class="token punctuation">,</span>
    customLaunchers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      ChromeHeadlessNoSandbox<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        base<span class="token punctuation">:</span> <span class="token string">'ChromeHeadless'</span><span class="token punctuation">,</span>
        flags<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token string">'--no-sandbox'</span><span class="token punctuation">,</span>
          <span class="token comment">// Without a remote debugging port, Google Chrome exits immediately.</span>
          <span class="token string">'--remote-debugging-port=9222'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>your final <code>src/karma.conf.js</code> might look like:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// Karma configuration file, see link for more information</span>
<span class="token comment">// https://karma-runner.github.io/1.0/config/configuration-file.html</span>

process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CHROME_BIN</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executablePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    basePath<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    frameworks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'jasmine'</span><span class="token punctuation">,</span> <span class="token string">'@angular-devkit/build-angular'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'karma-jasmine'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'karma-chrome-launcher'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'karma-jasmine-html-reporter'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'karma-coverage-istanbul-reporter'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@angular-devkit/build-angular/plugins/karma'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    client<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      clearContext<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment">// leave Jasmine Spec Runner output visible in browser</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    coverageIstanbulReporter<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      dir<span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../coverage'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      reports<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'html'</span><span class="token punctuation">,</span> <span class="token string">'lcovonly'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      fixWebpackSourcePaths<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    reporters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'progress'</span><span class="token punctuation">,</span> <span class="token string">'kjhtml'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token number">9876</span><span class="token punctuation">,</span>
    colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    logLevel<span class="token punctuation">:</span> config<span class="token punctuation">.</span><span class="token constant">LOG_INFO</span><span class="token punctuation">,</span>
    autoWatch<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Chrome'</span><span class="token punctuation">,</span> <span class="token string">'ChromeHeadlessNoSandbox'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    captureTimeout<span class="token punctuation">:</span> <span class="token number">210000</span><span class="token punctuation">,</span>
    browserDisconnectTolerance<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    browserDisconnectTimeout<span class="token punctuation">:</span> <span class="token number">210000</span><span class="token punctuation">,</span>
    browserNoActivityTimeout<span class="token punctuation">:</span> <span class="token number">210000</span><span class="token punctuation">,</span>
    customLaunchers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      ChromeHeadlessNoSandbox<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        base<span class="token punctuation">:</span> <span class="token string">'ChromeHeadless'</span><span class="token punctuation">,</span>
        flags<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token string">'--no-sandbox'</span><span class="token punctuation">,</span>
          <span class="token comment">// Without a remote debugging port, Google Chrome exits immediately.</span>
          <span class="token string">'--remote-debugging-port=9222'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    singleRun<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>Normally you would test your app with:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>ng <span class="token function">test</span>
</code></pre></div><p>You can try and run that. It will run the tests in your local browser. And that's how you should test it during development.</p> <p><strong>Note</strong>: as of now, 2018-06-29, a new, freshly generated Angular CLI project will fail 1 test, looking for a string <code>'Welcome to my-frontend-project!'</code>, you can change the string to <code>'Welcome to app!'</code> to fix the test.</p> <ul><li><p>In a Docker container, in your &quot;integration&quot; or &quot;production&quot; server, the tests will run in Chrome headless. So, let's first make sure that Chrome headless runs locally.</p></li> <li><p>Run a <em>single</em> (not &quot;watch&quot;) test locally, in headless mode:</p></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>ng <span class="token function">test</span> --browsers ChromeHeadlessNoSandbox --watch<span class="token operator">=</span>false
</code></pre></div><p>It should show that the tests are run in the console, and that they are passing (or not), but most importantly, it shouldn't open a Chrome browser window, as it will be running in Chrome headless mode.</p> <p>The image <a href="https://hub.docker.com/r/tiangolo/node-frontend/" target="_blank" rel="noopener noreferrer">tiangolo/node-frontend<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> already includes all the dependencies for Puppeteer, which is what is used to run your tests in Chrome Headless. So you don't have to add anything to your <code>Dockerfile</code> appart from running your tests.</p> <hr> <p><strong>Optional read</strong></p> <p>If you don't want to use <code>tiangolo/node-frontend</code> you will have to install Puppeteer and it's dependencies by hand, here's how.</p> <p>Right below the line:</p> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>FROM node:10.5 as build-stage
</code></pre></div><p>...add the installation of <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md#running-puppeteer-in-docker" target="_blank" rel="noopener noreferrer">Puppeteer's dependencies<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, the start of your <code>Dockerfile</code> should contain:</p> <div class="language-Dockerfile extra-class"><pre class="language-text"><code># Stage 0, &quot;build-stage&quot;, based on Node.js, to build and compile Angular
FROM node:10.5 as build-stage

# See https://crbug.com/795759
RUN apt-get update &amp;&amp; apt-get install -yq libgconf-2-4

# Install latest chrome dev package and fonts to support major charsets (Chinese, Japanese, Arabic, Hebrew, Thai and a few others)
# Note: this installs the necessary libs to make the bundled version of Chromium that Puppeteer
# installs, work.
RUN apt-get update &amp;&amp; apt-get install -y wget --no-install-recommends \
    &amp;&amp; wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - \
    &amp;&amp; sh -c 'echo &quot;deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main&quot; &gt;&gt; /etc/apt/sources.list.d/google.list' \
    &amp;&amp; apt-get update \
    &amp;&amp; apt-get install -y google-chrome-unstable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst ttf-freefont \
      --no-install-recommends \
    &amp;&amp; rm -rf /var/lib/apt/lists/* \
    &amp;&amp; apt-get purge --auto-remove -y curl \
    &amp;&amp; rm -rf /src/*.deb

...
</code></pre></div><p><strong>End optional read</strong></p> <hr> <ul><li>Then you can run your tests, after the section with:</li></ul> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>COPY ./ /app/
</code></pre></div><p>...add</p> <div class="language-Dockerfile extra-class"><pre class="language-text"><code>RUN npm run test -- --browsers ChromeHeadlessNoSandbox --watch=false
</code></pre></div><p>...that command will run the tests in headless mode, at build time. So, you can now integrate that with your CI systems and have your frontend tested every time the image is built. If a test fails, the build fails. So if you set up continuous integration and deployment (automatic deployments), you can be safe knowing that you won't deploy code with broken tests.</p> <p>Your final <code>Dockerfile</code> would look like:</p> <div class="language-Dockerfile extra-class"><pre class="language-text"><code># Stage 0, &quot;build-stage&quot;, based on Node.js, to build and compile the frontend
FROM tiangolo/node-frontend:10 as build-stage

WORKDIR /app

COPY package*.json /app/

RUN npm install

COPY ./ /app/

RUN npm run test -- --browsers ChromeHeadlessNoSandbox --watch=false

ARG configuration=production

RUN npm run build -- --output-path=./dist/out --configuration $configuration


# Stage 1, based on Nginx, to have only the compiled app, ready for production with Nginx
FROM nginx:1.15

COPY --from=build-stage /app/dist/out/ /usr/share/nginx/html

# Copy the default nginx.conf provided by tiangolo/node-frontend
COPY --from=build-stage /nginx.conf /etc/nginx/conf.d/default.conf
</code></pre></div><hr> <p><strong>Optional read</strong></p> <p>If you didn't use the image <code>tiangolo/node-frontend</code> your final complete <code>Dockerfile</code> would look something like:</p> <div class="language-Dockerfile extra-class"><pre class="language-text"><code># Stage 0, &quot;build-stage&quot;, based on Node.js, to build and compile Angular
FROM node:10.5 as build-stage

# See https://crbug.com/795759
RUN apt-get update &amp;&amp; apt-get install -yq libgconf-2-4

# Install latest chrome dev package and fonts to support major charsets (Chinese, Japanese, Arabic, Hebrew, Thai and a few others)
# Note: this installs the necessary libs to make the bundled version of Chromium that Puppeteer
# installs, work.
RUN apt-get update &amp;&amp; apt-get install -y wget --no-install-recommends \
    &amp;&amp; wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - \
    &amp;&amp; sh -c 'echo &quot;deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main&quot; &gt;&gt; /etc/apt/sources.list.d/google.list' \
    &amp;&amp; apt-get update \
    &amp;&amp; apt-get install -y google-chrome-unstable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst ttf-freefont \
      --no-install-recommends \
    &amp;&amp; rm -rf /var/lib/apt/lists/* \
    &amp;&amp; apt-get purge --auto-remove -y curl \
    &amp;&amp; rm -rf /src/*.deb

WORKDIR /app

COPY package*.json /app/

RUN npm install

COPY ./ /app/

RUN npm run test -- --browsers ChromeHeadlessNoSandbox --watch=false

ARG configuration=production

RUN npm run build -- --output-path=./dist/out --configuration $configuration


# Stage 1, based on Nginx, to have only the compiled app, ready for production with Nginx
FROM nginx:1.15

COPY --from=build-stage /app/dist/out/ /usr/share/nginx/html

COPY ./nginx-custom.conf /etc/nginx/conf.d/default.conf
</code></pre></div><p><strong>End optional read</strong></p> <hr> <ul><li>To test that your new Docker image with tests works, just build it again, you should see the results in the console. Check the section above ...or just run:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t my-angular-project:prod <span class="token keyword">.</span>
</code></pre></div><br> <div class="tip custom-block"><p class="custom-block-title">BASED ON</p> <p><a href="https://medium.com/@tiangolo/angular-in-docker-with-nginx-supporting-environments-built-with-multi-stage-docker-builds-bb9f1724e984" target="_blank" rel="noopener noreferrer"><code>Angular in Docker with Nginx, supporting configurations / environments, built with multi-stage Docker builds and testing with Chrome Headless</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> article from Sebastián Ramírez on Medium</p></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/web-development-guidelines/assets/js/11.d21adb37.js" defer></script><script src="/web-development-guidelines/assets/js/app.619e207b.js" defer></script>
  </body>
</html>
